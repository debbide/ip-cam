name: Build Electron App

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'electron/**'
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Get version and build number
      id: get_version
      shell: bash
      run: |
        VERSION=$(jq -r '.version' package.json)
        # 使用短 commit hash 作为构建标识，避免重复 tag
        SHORT_SHA=${GITHUB_SHA::7}
        BUILD_VERSION="${VERSION}-${SHORT_SHA}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_version=$BUILD_VERSION" >> $GITHUB_OUTPUT

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Download MediaMTX
      run: |
        New-Item -ItemType Directory -Force -Path bin
        Invoke-WebRequest -Uri "https://github.com/bluenviron/mediamtx/releases/download/v1.9.3/mediamtx_v1.9.3_windows_amd64.zip" -OutFile "bin\mediamtx.zip"
        Expand-Archive -Path "bin\mediamtx.zip" -DestinationPath "bin" -Force
        Remove-Item "bin\mediamtx.zip"

    - name: Download FFmpeg
      run: |
        Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
        Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg-temp" -Force
        Copy-Item "ffmpeg-temp\ffmpeg-master-latest-win64-gpl\bin\ffmpeg.exe" -Destination "bin\ffmpeg.exe"
        Remove-Item "ffmpeg.zip"
        Remove-Item -Recurse -Force "ffmpeg-temp"

    - name: Install Dependencies
      run: npm install

    - name: Build Portable App
      run: npm run build:portable
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: IP-Cam-Streamer-Windows
        path: dist-electron/*.exe

    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.build_version }}
        name: "IP Cam Streamer v${{ steps.get_version.outputs.build_version }}"
        body: |
          ## 独立客户端 v${{ steps.get_version.outputs.version }}

          构建版本: ${{ steps.get_version.outputs.build_version }}

          Windows 独立版本，内置后端服务。
        files: dist-electron/*.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
