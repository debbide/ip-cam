name: Web Edition Build (Docker)

on:
  push:
    branches:
      - main
    paths:
      - 'ip-cam-web/**'
      - 'ip-cam-separated/backend/rtsp-server/**'
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'vite.config.ts'
      - 'tailwind.config.ts'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-web:
    runs-on: ubuntu-latest
    env:
      VERSION: "1.0.0"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ip-cam-web/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/ip-cam-web:latest
            ghcr.io/${{ github.repository_owner }}/ip-cam-web:${{ steps.version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: web-v${{ steps.version.outputs.VERSION }}
          name: "IP Cam Web Edition v${{ steps.version.outputs.VERSION }}"
          body: |
            ## IP Cam Streamer - Web Edition v${{ steps.version.outputs.VERSION }}

            一键部署的 Docker 镜像，支持浏览器直接访问（HTTPS + WebRTC）。

            ### 快速开始

            ```bash
            # 拉取镜像
            docker pull ghcr.io/${{ github.repository_owner }}/ip-cam-web:${{ steps.version.outputs.VERSION }}

            # 运行容器
            docker run -d \
              --name ip-cam-web \
              -p 80:80 \
              -p 443:443 \
              -p 8554:8554 \
              -p 8289:8289/udp \
              -v ipcam-data:/app/data \
              -v ipcam-ssl:/etc/nginx/ssl \
              ghcr.io/${{ github.repository_owner }}/ip-cam-web:${{ steps.version.outputs.VERSION }}
            ```

            ### 访问

            打开浏览器访问: `https://你的服务器IP`

            > 首次访问会提示证书不安全，点击"继续访问"即可。

            ### 端口说明

            | 端口 | 用途 |
            |------|------|
            | 443 | HTTPS Web 界面 |
            | 80 | HTTP (自动跳转 HTTPS) |
            | 8554 | RTSP |
            | 8289/udp | WebRTC ICE |

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
