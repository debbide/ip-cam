services:
  # 前端 Web 服务
  ip-cam-web:
    build: .
    container_name: ip-cam-streamer
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3000}:80"
    volumes:
      - hls-data:/usr/share/nginx/html/hls
    environment:
      - TZ=Asia/Shanghai
    depends_on:
      - rtsp-server

  # RTSP 转码服务
  rtsp-server:
    build: ./rtsp-server
    container_name: ip-cam-rtsp
    restart: unless-stopped
    ports:
      - "${RTSP_API_PORT:-3001}:3001"
    volumes:
      - hls-data:/app/hls
    environment:
      - TZ=Asia/Shanghai
      - HLS_OUTPUT_DIR=/app/hls
      - MEDIAMTX_API=http://mediamtx:9997

  # MediaMTX (RTSP/WebRTC Server)
  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: ip-cam-mediamtx
    restart: unless-stopped
    ports:
      - "8554:8554" # RTSP
      - "8889:8889" # WebRTC (WHEP)
      - "8888:8888" # HLS
      - "8189:8189/udp" # WebRTC ICE/STUN
    volumes:
      - ./mediamtx.yml:/mediamtx.yml
    environment:
      - MTX_API=yes
      - MTX_APIADDRESS=:9997

volumes:
  hls-data:
